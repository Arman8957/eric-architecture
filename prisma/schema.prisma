// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  //  output   = "../node_modules/.prisma/client" 
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  FINANCE
  HIGHER_MANAGER
  PROJECT_MANAGER
  DRAFTER
  EMPLOYEE
  USER
  MEDIA_MANAGER
}

enum ProjectStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum ProposalStatus {
  DRAFT
  SENT
  VIEWED
  ACCEPTED
  REJECTED
  EXPIRED
}

enum StageStatus {
  NOT_STARTED
  IN_PROGRESS
  INQUIRY
  ACTIVE
  BIDDING
  COMPLETED
  ON_HOLD
}

enum ProjectCategory {
  RESIDENTIAL
  COMMERCIAL
  INSTITUTIONAL
  LANDSCAPE
  INTERIOR
  URBAN_PLANNING
}

enum AssetType {
  IMAGE_2D // Photos, renders
  DRAWING_2D // Floor plans, sections (PDF, SVG, PNG)
  DOCUMENT_1D // Specifications, contracts (PDF, DOCX)
  MODEL_3D // GLB/GLTF/USDZ
  TOUR_360 // 360° panorama or virtual tour
  VIDEO // MP4 walkthroughs, animations
}

enum ServiceType {
  NEW_CONSTRUCTION
  RENOVATION
  ADDITION
  INTERIOR_DESIGN
  LANDSCAPE_DESIGN
  OTHER
}

enum RequestStatus {
  PENDING
  REVIEWED
  ACTIVE
  SCHEDULED
  COMPLETED
  CANCELLED
}

enum MediaContentType {
  WORLD_PROJECT
  PORTFOLIO
  ARTICLE
  NEWS
}

enum MediaStatus {
  DRAFT
  PENDING_REVIEW
  PUBLISHED
  ARCHIVED
  REJECTED
}

// ──────────────────────────────────────────────────────────────
// Core Models 
// ──────────────────────────────────────────────────────────────
model User {
  id                String             @id @default(uuid())
  email             String             @unique
  name              String?
  googleId          String?            @unique
  avatar            String?
  role              UserRole           @default(USER)
  isActive          Boolean            @default(true)
  lastLoginAt       DateTime?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  password          String? // hashed, optional for OAuth users
  refreshToken      String?
  emailVerified     Boolean            @default(false)
  emailVerifyToken  String?            @unique // for email verification
  emailVerifyExpiry DateTime? // token expiry
  projects          Project[]
  assets            ProjectAsset[] // new: unified assets
  comments          Comment[]
  likes             Like[]
  employeeProfile   EmployeeProfile?
  projectRequests   ProjectRequest[]
  mediaContents     MediaContent[]
  mediaAssets       MediaAsset[]
  mediaLikes        MediaLike[]
  mediaComments     MediaComment[]
  mediaCommentLikes MediaCommentLike[]
  proposals         Proposal[]         @relation("CreatedProposals")
  assignedProposals Proposal[]
  assignedStages    ProjectStage[]
  notification      Notification[]

  @@index([email])
  @@index([googleId])
  @@index([role])
  @@map("users")
}

// ──────────────────────────────────────────────────────────────
// NEW: Media Content Model (World Projects, Portfolio, Articles)
// ──────────────────────────────────────────────────────────────
model MediaContent {
  id          String           @id @default(uuid())
  contentType MediaContentType
  status      MediaStatus      @default(DRAFT)

  // Basic Info
  title   String
  slug    String  @unique
  excerpt String? @db.VarChar(500)
  content String  @db.Text

  // Media Specific Fields
  location    String? // For World Projects
  country     String?
  city        String?
  coordinates Json? // {lat, lng}

  projectYear   Int? // Completion year
  projectArea   Float? // Square footage/meters
  projectClient String?
  architect     String?
  photographer  String?

  // Portfolio specific
  category    ProjectCategory?
  projectTags String[] // e.g., ["luxury", "eco-friendly"]

  // Article specific
  author      String? // Author name (different from creator)
  publishDate DateTime?
  readTime    Int? // in minutes

  // SEO
  metaTitle       String?
  metaDescription String?
  metaKeywords    String[]

  // Featured content
  isFeatured    Boolean @default(false)
  featuredOrder Int?

  // Cover/Thumbnail
  coverImage     String?
  thumbnailImage String?

  // Relations
  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id])

  assets MediaAsset[]
  tags   MediaContentTag[]

  likes    MediaLike[]
  comments MediaComment[]

  // Analytics
  viewCount    Int @default(0)
  likeCount    Int @default(0)
  commentCount Int @default(0)
  shareCount   Int @default(0)

  // Timestamps
  publishedAt DateTime?
  archivedAt  DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([slug])
  @@index([contentType])
  @@index([status])
  @@index([createdById])
  @@index([isFeatured])
  @@index([publishedAt])
  @@index([country])
  @@index([city])
  @@map("media_contents")
}

// ──────────────────────────────────────────────────────────────
// NEW: Media Asset Model (for media content)
// ──────────────────────────────────────────────────────────────
model MediaAsset {
  id String @id @default(uuid())

  mediaContentId String
  mediaContent   MediaContent @relation(fields: [mediaContentId], references: [id], onDelete: Cascade)

  uploadedById String
  uploadedBy   User   @relation(fields: [uploadedById], references: [id])

  type    AssetType
  title   String?
  caption String?
  altText String?
  order   Int       @default(0)

  // File info
  originalUrl String
  cdnUrl      String
  fileSize    Int
  mimeType    String

  // Image specific
  width    Int?
  height   Int?
  format   String?
  blurHash String?
  sizes    Json? // {thumbnail, medium, large}

  // Video specific
  streamingUrl String?
  duration     Int?
  resolution   String?
  posterUrl    String? // Video thumbnail

  // 3D Model
  modelUrl     String?
  usdzUrl      String?
  thumbnailUrl String?

  // Processing
  isProcessed   Boolean @default(false)
  processStatus String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([mediaContentId])
  @@index([uploadedById])
  @@index([type])
  @@index([order])
  @@map("media_assets")
}

// ──────────────────────────────────────────────────────────────
// NEW: Media Content Tags
// ──────────────────────────────────────────────────────────────
model MediaTag {
  id        String            @id @default(uuid())
  name      String            @unique
  slug      String            @unique
  contents  MediaContentTag[]
  createdAt DateTime          @default(now())

  @@index([slug])
  @@map("media_tags")
}

model MediaContentTag {
  mediaContentId String
  tagId          String

  mediaContent MediaContent @relation(fields: [mediaContentId], references: [id], onDelete: Cascade)
  tag          MediaTag     @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([mediaContentId, tagId])
  @@map("media_content_tags")
}

model MediaLike {
  id             String   @id @default(uuid())
  userId         String
  mediaContentId String
  createdAt      DateTime @default(now())

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  mediaContent MediaContent @relation(fields: [mediaContentId], references: [id], onDelete: Cascade)

  @@unique([userId, mediaContentId]) // one like per user per media
  @@index([mediaContentId])
  @@index([userId])
  @@map("media_likes")
}

// ──────────────────────────────────────────────────────────────
// Comments for MediaContent 
// ──────────────────────────────────────────────────────────────
model MediaComment {
  id             String  @id @default(uuid())
  content        String  @db.Text
  userId         String
  mediaContentId String
  parentId       String? // for replies

  mediaContent MediaContent   @relation(fields: [mediaContentId], references: [id], onDelete: Cascade)
  user         User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  parent       MediaComment?  @relation("MediaCommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies      MediaComment[] @relation("MediaCommentReplies")

  isApproved Boolean            @default(true) // for moderation (articles/news)
  likeCount  Int                @default(0) // optional - denormalized
  createdAt  DateTime           @default(now())
  updatedAt  DateTime           @updatedAt
  // mediaCommentLikes MediaCommentLike[]
  likes      MediaCommentLike[]

  @@index([mediaContentId])
  @@index([userId])
  @@index([parentId])
  @@index([createdAt(sort: Desc)])
  @@map("media_comments")
}

// Optional: Likes on Comments (very useful for articles & news)
model MediaCommentLike {
  id        String   @id @default(uuid())
  userId    String
  commentId String
  createdAt DateTime @default(now())

  user    User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  comment MediaComment @relation(fields: [commentId], references: [id], onDelete: Cascade)

  @@unique([userId, commentId])
  @@index([commentId])
  @@map("media_comment_likes")
}

//=================================project req==========================

model ProjectRequest {
  id                          String           @id @default(uuid())
  // Client Details
  clientFirstName             String
  clientMiddleName            String?
  clientLastName              String
  companyName                 String?
  email                       String
  phone                       String?
  country                     String           @default("United States")
  state                       String?
  city                        String?
  streetAddress               String?
  additionalComments          String?
  // Project Details
  projectName                 String
  projectLocationSameAsClient Boolean          @default(false)
  projectCountry              String?
  projectState                String?
  projectCity                 String?
  projectStreetAddress        String?
  projectZipCode              String?
  serviceType                 ServiceType      @default(NEW_CONSTRUCTION)
  projectCategory             ProjectCategory?
  projectSize                 String? // e.g., "2000 sq ft" or Float for area
  budgetRange                 String? // e.g., "100k-250k"
  // Architectural Preferences
  preferredArchitecturalStyle String?
  siteConstraints             String?
  // Sustainability and Special Requirements
  sustainabilityGoals         String?
  specialRequirements         String?
  // Appointment
  appointmentDate             DateTime?
  appointmentTime             String? // e.g., "10:00 AM"
  appointmentType             String? // e.g., "Initial Consultation"
  additionalNotes             String?

  stages ProjectStage[]

  // Assets

  // Status and Relations
  status    RequestStatus  @default(PENDING)
  userId    String? // Optional link to registered user
  user      User?          @relation(fields: [userId], references: [id])
  assets    ProjectAsset[] // Uploaded documents/photos
  // Timestamps
  deletedAt DateTime?
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  proposals Proposal[]

  @@index([email])
  @@index([status])
  @@index([deletedAt])
  @@index([userId])
  @@index([createdAt])
  @@map("project_requests")
}

model Proposal {
  id String @id @default(uuid())
  
  // Links
  projectRequestId String
  projectRequest   ProjectRequest @relation(fields: [projectRequestId], references: [id])
  
  userId           String? // The client this proposal is for
  user             User?            @relation(fields: [userId], references: [id])
  
  proposalNumber   String          @unique
  title            String
  subject          String?
  
  // Client Info (can differ from user)
  clientName    String
  clientEmail   String
  clientPhone   String?
  clientCompany String?
  
  // Project Details
  projectName        String
  projectLocation    String
  projectDescription String? @db.Text
  additionalContext  String? @db.Text
  
  // Specifications
  serviceType      ServiceType
  projectCategory  ProjectCategory?
  squareFootage    String?
  budgetRange      String?
  expectedTimeline String? // e.g., "3-6 months"
  
  // Status
  status      ProposalStatus @default(DRAFT)
  sentAt      DateTime?
  viewedAt    DateTime?
  respondedAt DateTime?
  expiresAt   DateTime?
  
  // Services
  services ProposalService[]
  
  // Financials
  subtotal    Decimal  @default(0) @db.Decimal(10, 2)
  taxRate     Decimal? @db.Decimal(5, 2)
  taxAmount   Decimal? @db.Decimal(10, 2)
  totalAmount Decimal  @default(0) @db.Decimal(10, 2)
  
  // Credits/Discounts
  credits ProposalCredit[]
  
  // Payment
  paymentMethod String? // "LUMP_SUM" or "INSTALLMENT"
  paymentTerms  String? @db.Text
  
  // Schedule & Contact
  estimatedDuration String?
  contactInfo       String? @db.Text
  
  // Signatures
  ownerSignature String?
  ownerSignedAt  DateTime?
  ownerSignedBy  String?
  
  architectSignature String?
  architectSignedAt  DateTime?
  architectSignedBy  String? // "Eric Rivera, AIA"
  
  // Additional
  notes              String? @db.Text
  termsAndConditions String? @db.Text
  
  // Metadata
  createdById String
  createdBy   User   @relation("CreatedProposals", fields: [createdById], references: [id])
  
  // If accepted, link to actual project stages
  projectStages ProjectStage[]
  
  // ✅ FIX: Optional link to Project (only scalar field, no @relation attributes)
  projectId String?   @unique
  project   Project?  // ← Remove @relation here, it's defined on the other side
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([userId])
  @@index([proposalNumber])
  @@index([status])
  @@index([projectRequestId])
  @@map("proposals")
}

model ProposalService {
  id         String   @id @default(uuid())
  proposalId String
  proposal   Proposal @relation(fields: [proposalId], references: [id], onDelete: Cascade)

  name          String // e.g., "Assemble Information"
  description   String? @db.Text
  order         Int     @default(0)
  timelineWeeks Int? // add if needed
  active        Boolean @default(true)

  // Pricing
  rate     Decimal? @db.Decimal(10, 2)
  quantity Int      @default(1)
  unit     String? // "weeks", "hours", "sq ft"
  amount   Decimal  @db.Decimal(10, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([proposalId])
  @@index([order])
  @@map("proposal_services")
}

model ProposalCredit {
  id         String   @id @default(uuid())
  proposalId String
  proposal   Proposal @relation(fields: [proposalId], references: [id], onDelete: Cascade)

  type        String // "DOLLAR_AMOUNT" or "PERCENTAGE"
  amount      Decimal @db.Decimal(10, 2)
  description String? @db.Text

  createdAt DateTime @default(now())

  @@index([proposalId])
  @@map("proposal_credits")
}

model ProjectStage {
  id String @id @default(uuid())

  // Links
  proposalId String?
  proposal   Proposal? @relation(fields: [proposalId], references: [id])

  // Stage Info
  name        String // "Schematic Design", "Design Development", etc.
  description String? @db.Text
  order       Int     @default(0)

  projectId String?
  project   Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)

  // Progress
  status   StageStatus @default(NOT_STARTED)
  progress Int         @default(0) // 0-100

  // Tasks
  totalTasks     Int @default(0)
  completedTasks Int @default(0)

  // Timeline
  startDate   DateTime?
  dueDate     DateTime?
  completedAt DateTime?

  // Assignment
  assignedToId String?
  assignedTo   User?   @relation(fields: [assignedToId], references: [id])

  // Tracking
  notes String? @db.Text

  // Metadata
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  projectRequest   ProjectRequest? @relation(fields: [projectRequestId], references: [id])
  projectRequestId String?

  @@index([proposalId])
  @@index([status])
  @@index([assignedToId])
  @@map("project_stages")
}

//===========notification========
model Notification {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      String // NEW_REQUEST, STATUS_UPDATED, etc.
  title     String
  message   String
  link      String?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
}

//==================================project req========================

model EmployeeProfile {
  id         String   @id @default(uuid())
  userId     String   @unique
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  employeeId String   @unique
  department String?
  position   String?
  joinDate   DateTime @default(now())
  phone      String?
  address    String?
  salary     Decimal? @db.Decimal(10, 2)

  @@index([employeeId])
  @@map("employee_profiles")
}

// ──────────────────────────────────────────────────────────────
// PROJECT – now uses unified assets
// ──────────────────────────────────────────────────────────────
model Project {
  id             String          @id @default(uuid())
  title          String
  slug           String          @unique
  description    String          @db.Text
  shortDesc      String?         @db.VarChar(300)
  category       ProjectCategory
  status         ProjectStatus   @default(DRAFT)
  location       String?
  area           Float?
  completionYear Int?
  clientName     String?
  
  // SEO
  metaTitle       String?
  metaDescription String?
  metaKeywords    String[]
  
  stages ProjectStage[]
  
  // Media (now via ProjectAsset)
  coverImage String?
  assets     ProjectAsset[]
  
  // Performance & Relations
  viewCount     Int          @default(0)
  featuredOrder Int?
  authorId      String
  author        User         @relation(fields: [authorId], references: [id])
  tags          ProjectTag[]
  comments      Comment[]
  likes         Like[]
  
  proposalId String?   @unique
  proposal   Proposal? @relation(fields: [proposalId], references: [id], onDelete: SetNull)
  
  publishedAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([slug])
  @@index([status])
  @@index([category])
  @@index([authorId])
  @@index([featuredOrder])
  @@index([publishedAt])
  @@map("projects")
}

// ──────────────────────────────────────────────────────────────
// UNIFIED ASSET SYSTEM (replaces ProjectImage + ProjectVideo)
// ──────────────────────────────────────────────────────────────
model ProjectAsset {
  id String @id @default(uuid())

  // Both relations are now optional (polymorphic: belongs to Project OR ProjectRequest OR neither)
  projectId String?
  project   Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)

  projectRequestId String?
  projectRequest   ProjectRequest? @relation(fields: [projectRequestId], references: [id], onDelete: SetNull)

  uploadedById String?
  uploadedBy   User?   @relation(fields: [uploadedById], references: [id])

  type    AssetType
  title   String?
  caption String?
  order   Int       @default(0)

  // Universal
  originalUrl String
  cdnUrl      String
  fileSize    Int
  mimeType    String

  // 2D Image / Drawing
  width    Int?
  height   Int?
  format   String?
  blurHash String?
  altText  String?
  sizes    Json?

  // 3D Model
  modelUrl      String?
  usdzUrl       String?
  thumbnailUrl  String?
  polygonCount  Int?
  hasAnimations Boolean? @default(false)

  // Video
  streamingUrl String?
  duration     Int?
  resolution   String?

  // 360 / Document
  pageCount    Int?
  isSearchable Boolean? @default(false)

  // Processing state
  isProcessed   Boolean @default(false)
  processStatus String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([projectId])
  @@index([projectRequestId])
  @@index([type])
  @@index([order])
  @@index([isProcessed])
  @@index([uploadedById])
  @@map("project_assets")
}

// ──────────────────────────────────────────────────────────────
// Rest of your models
// ──────────────────────────────────────────────────────────────
model Tag {
  id        String       @id @default(uuid())
  name      String       @unique
  slug      String       @unique
  projects  ProjectTag[]
  createdAt DateTime     @default(now())

  @@index([slug])
  @@map("tags")
}

model ProjectTag {
  projectId String
  tagId     String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tag       Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([projectId, tagId])
  @@map("project_tags")
}

model Comment {
  id         String    @id @default(uuid())
  content    String    @db.Text
  projectId  String
  project    Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  userId     String
  user       User      @relation(fields: [userId], references: [id])
  parentId   String?
  parent     Comment?  @relation("CommentReplies", fields: [parentId], references: [id])
  replies    Comment[] @relation("CommentReplies")
  isApproved Boolean   @default(false)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  @@index([projectId])
  @@index([userId])
  @@index([parentId])
  @@map("comments")
}

model Like {
  id        String   @id @default(uuid())
  projectId String
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())

  @@unique([projectId, userId])
  @@index([projectId])
  @@index([userId])
  @@map("likes")
}

model ContactInquiry {
  id        String   @id @default(uuid())
  name      String
  email     String
  phone     String?
  subject   String
  message   String   @db.Text
  isRead    Boolean  @default(false)
  isReplied Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([isRead])
  @@index([createdAt])
  @@map("contact_inquiries")
}

model Newsletter {
  id           String   @id @default(uuid())
  email        String   @unique
  isActive     Boolean  @default(true)
  subscribedAt DateTime @default(now())

  @@index([email])
  @@map("newsletters")
}

model SiteSettings {
  id          String   @id @default(uuid())
  key         String   @unique
  value       String   @db.Text
  description String?
  updatedAt   DateTime @updatedAt

  @@map("site_settings")
}
